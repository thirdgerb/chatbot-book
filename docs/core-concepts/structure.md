#   对话机器人技术架构

有完全本地化的对话机器人, 也有网络化的对话机器人. 后者可分为客户端与服务端. 本文主要讨论网络对话机器人.

对话机器人的简单技术架构如下:

* 客户端 : 负责与用户之间的交互
* 服务端 : 响应对话逻辑
    - 客户端通信
    - 输入解析
    - 输出合成
    - 语义解析
    - 对话管理
    - 业务逻辑
    - 服务端架构

## 客户端

客户端要向用户提供一套可 "对话" (包括自然语言的文字, 和语音) 的交互界面.

现有常见的客户端有:

* __即时通讯平台__: 微信, qq等
* __电话__
* __语音平台__ : 例如智能音箱, 智能耳机
* __模拟对话的web界面__ : 例如消息中心, 私信, 在线客服
* __聊天室__ : 例如[slack](https://slack.com/intl/en-cn/)
* __语音机器人__ : 例如商场问路, 导购机器人
* __机器人平台__ : 例如微软的[bot framework](https://dev.botframework.com/)
* __智能音箱, 耳机__ : 例如百度 duerOS, 亚马逊 Echo, 天猫精灵, 小爱同学等.

每种客户端都会有自己的输入输出模型. 但在服务端可以统一抽象成相通的 message, 从而使一个服务端机器人可以对接多种客户端, 甚至实现```全平台适配```. CommuneChatbot 目前对接了微信公众号和百度智能音箱. 

## 服务端

服务端负责响应对话逻辑, 有以下功能点

### 客户端通信

机器人服务端与客户端通信, 通常有以下两种方式:

* 客户端直连服务端 
* 服务端中转 : 客户端自有服务端, 再由服务端中转数据给机器人的服务端, 例如微信公众号.

值得关注的是通信的模式:

* __同步响应__ : 只有用户发来消息, 服务端才响应
* __消息通道__ : 双方通过消息管道 ( 例如kafka, rabbitMq等 ) 来通信, 本质是异步的
* __双工通道__ : 双方可以同时发送和接受信息

实际业务可能有不同通信模式的组合. 而是否允许异步发送消息, 对业务形态的影响最关键.

### 输入解析

主要指对输入的信息进行统一的抽象化, 使消息能被服务端处理. 值得关注的有 :

* __语音转文字__
* __多媒体支持__
* __身份鉴别__
* __事件机制__ : 输入的不一定是自然语言消息, 也可能是操作事件
* __会话追踪__ : 会话可追踪对于开发与调试极其重要

### 输出解析

机器人服务端会对用户的请求作出响应, 然而响应在每个客户端上都会有不同的呈现. 因此需要对响应进行统一的抽象, 且每个客户端做不同的渲染. 值得关注的有:

* __输出转语音__ : 例如 W3C 的[ssml规范](https://www.w3.org/TR/speech-synthesis/)
* __多媒体输出__
* __富文本输出__ : 例如将输出做成卡片, 按钮等.
* __指令输出__ : 如果客户端对接设备, 例如智能音箱对接智能家具, 还可能需要下发指令

### 语义解析

人机交互的本质, 就是将人的各种模态的输入(文字,语音,动作,姿势,视觉等) 转化为机器可以响应的数字指令. 

从人机交互角度看, 传统的指令形式是命令单词 (例如"芝麻开门"), 或者有严谨语法的命令行 (例如 ```git commit -m "message"```)

随着自然语言技术的发展, 可以将人类的自然语言也解析成指令. 例如 "北京明天天气如何" => "askWeather city:北京 date:明天". 于是出现了 "意图" 与 "实体" 的概念:

* 意图: 可以理解为命令名
* 实体: 可以理解为提取出来的命令参数

目前对话机器人的语义理解, 主要包括:

* 文字 => 语义 + 实体
* 语音 => 文字 => 语义 + 实体
* 语音 => 语义 + 实体

而未来的对话交互是富文本 + 多媒体的, 语义理解的对象会进一步发展到 :

* 表情包
* 图片
* 视频等

而语义理解的内容, 也可能扩展到 "情绪" 等更为基础的抽象概念上. 

### 对话管理

所有人机交互的软件, 都存在 __状态管理__ 的需要. 对于网站而言, 状态主要保存在浏览器上, 表现为页面, 通常由 __javascript__ 编程管理. 桌面应用, 触屏 app 也与之类似.

__状态__ 通常意味着:

* 输出有限的信息
* 响应有限的命令
* 状态可以切换, 跳转, 回退

传统的 MVC 服务端框架, 是将状态管理交给客户端, 而服务端负责响应无状态的请求.

复杂的 __对话机器人__ 有更强烈的状态管理需要. 这是因为自然语言往往不能一次提供指令所需的所有信息, 而要进行多轮对话.

例如提交用户的姓名, 年龄等信息, 网站只需要填写完表单后一次提交. 而对话形式, 则可能有多轮一问一答的交互. 因此对话机器人需要有 "对话管理" 模块, 负责各种语境的切换, 上下文记忆等. 



CommuneChatbot 项目最主要的功能就是多轮对话管理. 类似的项目还有: 

### 业务逻辑

简单的对话机器人, 只需要用自然语言回复用户就足够, 通常只负责实现简单的业务逻辑. 

从 __对话式交互__ 角度定义的对话机器人, 则要像网站, app 一样负责执行各种业务逻辑: 调用各种微服务和第三方接口, 查询各种数据库 (包括知识图谱), 做各种运算, 发送各种指令给硬件, 并且将信息反馈给用户.

因此, 对话机器人要全面支持业务逻辑, 功能上也需要对标其它交互形式的软件.

### 服务端架构

工业级可用的对话机器人, 同样要像其它服务端工程一样考虑各种架构问题:

* 分布式部署
* 分布式一致性
* 高性能
* 高可用
* 可迭代
* 快速发布, 弹性扩容
* 容错, 灾备
* 服务化, 服务治理
* 组件化, 可配置

## 中间件

对话机器人需要的各种技术模块, 不一定都由自己来开发, 有各种供应商可以提供某一项技术模块的中间件服务.

以主要的语音, 语义服务为例:

* [百度UNIT](https://ai.baidu.com/unit/home)
* [讯飞开放平台](https://www.xfyun.cn/)
* [阿里Genie](https://www.aligenie.com/skills)
* [谷歌DialogFlow](https://dialogflow.com/)
* [脸书wit](http://wit.ai/)

您也可以用一些开源项目搭建自己的中间件服务, 例如:

* [对话机器人框架 Rasa NLU](https://rasa.com/)
* [自然语言处理框架 Spacy](https://spacy.io/)

## CommuneChatbot 定位

CommuneChatbot 项目定位为对话机器人的服务端, 主要实现以下功能:

* 对接各种客户端
* 对接输入解析, 语义解析, 输出解析单元
* 提供对话管理, 实现复杂多轮对话
* 提供业务逻辑支持
* 考虑服务端架构需要.


